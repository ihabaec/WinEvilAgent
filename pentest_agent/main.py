import argparse
import logging
import os
from datetime import datetime
from typing import Optional

# Import the main agent class
from .agent import PentestAgent
def setup_logging(log_level: str = 'INFO', log_file: Optional[str] = None):
    """
    Sets up global logging configuration.
    """
    log_dir = "logs"
    if not os.path.exists(log_dir):
        os.makedirs(log_dir)

    log_format = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    date_format = '%Y-%m-%d %H:%M:%S'

    handlers = []

    # Console handler (only show INFO+)
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(logging.Formatter(log_format, datefmt=date_format))
    console_handler.setLevel(logging.INFO)  # only allow INFO and above
    handlers.append(console_handler)

    # File handler (log everything)
    if log_file:
        file_path = os.path.join(log_dir, log_file)
        file_handler = logging.FileHandler(file_path, encoding='utf-8')
        file_handler.setFormatter(logging.Formatter(log_format, datefmt=date_format))
        file_handler.setLevel(getattr(logging, log_level.upper(), logging.DEBUG))
        handlers.append(file_handler)

    logging.basicConfig(
        level=logging.DEBUG,  # Capture all logs globally
        handlers=handlers
    )

    # Quiet down noisy libraries
    logging.getLogger('requests').setLevel(logging.WARNING)
    logging.getLogger('urllib3').setLevel(logging.WARNING)
    logging.getLogger('winrm').setLevel(logging.WARNING)


def main():
    """Main entry point for the PentestAgent application."""
    parser = argparse.ArgumentParser(description='Enhanced Penetration Testing Agent')
    parser.add_argument('--mode', choices=['auto', 'interactive', 'create-samples'],
                        default='auto', help='Execution mode: "auto" for full automation, "interactive" for manual control, "create-samples" to generate config files.')
    parser.add_argument('--enum-file', default='enum.yaml',
                        help='Path to enumeration YAML file.')
    parser.add_argument('--priv-file', default='priv.yaml',
                        help='Path to privilege escalation YAML file.')
    parser.add_argument('--config', default='.env',
                        help='Path to environment configuration file (.env).')
    parser.add_argument('--log-level', choices=['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'],
                        default='INFO', help='Set the logging level (e.g., INFO, DEBUG).')
    parser.add_argument('--log-file', default=None,
                        help='Specify a file name for logging output. If not set, logs only to console. Example: agent_run.log')
    
    args = parser.parse_args()
    
    # Setup logging first
    if args.log_file is None:
        # Use a timestamped log file name for auto mode if not specified
        if args.mode == 'auto':
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            args.log_file = f"agent_auto_{timestamp}.log"
        else:
            # For interactive mode, only log to console by default if no file specified
            pass
    
    setup_logging(log_level=args.log_level, log_file=args.log_file)

    
    try:
        # Initialize agent with custom file paths
        agent = PentestAgent(
            config_file=args.config,
            enum_file=args.enum_file,
            priv_file=args.priv_file
        )
        
        if args.mode == 'auto':
            agent.run()
        elif args.mode == 'interactive':
            agent.run_interactive_mode()
            
    except KeyboardInterrupt:
        logging.info("\n\n⚠️  Execution interrupted by user.")
    except Exception as e:
        logging.exception(f"\n❌ A critical error occurred: {e}") # Use logging.exception to include traceback

if __name__ == "__main__":
    main()